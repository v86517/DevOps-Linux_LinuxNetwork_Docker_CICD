## Part 1. Инструмент ipcalc  
Устанавливаем утилиту ipcalc
`sudo apt update`
`sudo apt install ipcalc`
### 1.1. Сети и маски  
#### 1) Определяем адрес сети 192.167.38.54/13  
`ipcalc -b 192.167.38.54/13`  
`-b` означает скрыть двоичную запись  
![01.1.1 ipcalc -b 192.167.38.54_13.png](./images/01.1.1%20ipcalc%20-b%20192.167.38.54_13.png)

#### 2) Переводим маску 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную  
* `ipcalc 255.255.255.0`  
![01.1.2.1 ipcalc 255.255.255.0.png](./images/01.1.2.1%20ipcalc%20255.255.255.0.png)  
Префиксная запись `/24`. 
Двоичная запись - `11111111.11111111.11111111.00000000`  

* `ipcalc /15`  
![01.1.2.2 ipcalc _15.png](./images/01.1.2.2%20ipcalc%20_15.png)  
Обычная запись - `255.254.0.0`. 
Двоичная запись - `11111111.11111110.00000000.00000000`  

* `ipcalc 192.167.38.54/28` (`28`количество ненулевых бит в двоичной записи маски 11111111.11111111.11111111.11110000).  
![01.1.2.3 ipcalc _11111111.11111111.png](./images/01.1.2.3%20ipcalc%20_11111111.11111111.png)  
Обычная запись - `255.255.255.240`.
Префиксная запись - `/28`.  

#### 3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4  

* `ipcalc 12.167.38.4/8`  
![01.1.3.1 ipcalc 12.167.38.4_8.png](./images/01.1.3.1%20ipcalc%2012.167.38.4_8.png)  
Минимальный хост - `12.0.0.1`. 
Максимальный хост - `12.255.255.254`.  

* `ipcalc 12.167.38.4/16`  
![01.1.3.2 ipcalc 12.167.38.4_16.png](./images/01.1.3.2%20ipcalc%2012.167.38.4_16.png)  
Минимальный хост - `12.167.0.1`.
Максимальный хост - `12.167.255.254`.  

* `ipcalc 12.167.38.4/255.255.254.0`  
![01.1.3.3 ipcalc 12.167.38.4_255.255.254.0.png](./images/01.1.3.3%20ipcalc%2012.167.38.4_255.255.254.0.png)  
Минимальный хост - `12.167.38.1`.
Максимальный хост - `12.167.39.254`.  

* `ipcalc 12.167.38.4/4`  
![01.1.3.4 ipcalc 12.167.38.4_4.png](./images/01.1.3.4%20ipcalc%2012.167.38.4_4.png)  
Минимальный хост - `0.0.0.1`.
Максимальный хост - `15.255.255.254`.  

### 1.2. Localhost  
#### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1  
Диапазон ip адресов зарезервированный для localhost 127.0.0.1 — 127.255.255.254.
Можно обратиться к приложению, работающему со следующими ip: 127.0.0.2, 127.1.0.1.  
Проверяем:  
* `ipcalc 194.34.23.100`  
![01.2.1.1 ipcalc 194.34.23.100.png](./images/01.2.1.1%20ipcalc%20194.34.23.100.png)  
В строке "Hosts/Net" нет интерфейса loopback.  

* `ipcalc 127.0.0.2`  
![01.2.1.2 ipcalc 127.0.0.2.png](./images/01.2.1.2%20ipcalc%20127.0.0.2.png)  
В строке "Hosts/Net" есть интерфейс loopback.  

* `ipcalc 127.1.0.1`  
![01.2.1.3 ipcalc 127.1.0.1.png](./images/01.2.1.3%20ipcalc%20127.1.0.1.png)  
В строке "Hosts/Net" есть интерфейс loopback.  

* `ipcalc 128.0.0.1`  
![01.2.1.4 ipcalc 128.0.0.1.png](./images/01.2.1.4%20ipcalc%20128.0.0.1.png)  
В строке "Hosts/Net" нет интерфейса loopback.  

### 1.3. Диапазоны и сегменты сетей  
#### 1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1  
 
Диапазоны частных IP адресов:
10.0.0.0 — 10.255.255.255
100.64.0.0 — 100.127.255.255
172.16.0.0 — 172.31.255.255
192.168.0.0 — 192.168.255.255
Можно использовать в качестве публичного: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1.
Можно использовать только в качестве частных: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10.

Проверяем:
* `ipcalc -b 10.0.0.45`  
![01.3.1.1 ipcalc 10.0.0.45.png](./images/01.3.1.1%20ipcalc%2010.0.0.45.png)  
В строке "Hosts/Net" есть Private Internet

* `ipcalc -b 134.43.0.2`  
![01.3.1.2 ipcalc 134.43.0.2.png](./images/01.3.1.2%20ipcalc%20134.43.0.2.png)  
В строке "Hosts/Net" нет Private Internet

* `ipcalc -b 192.168.4.2`  
![01.3.1.3 ipcalc 192.168.4.2.png](./images/01.3.1.3%20ipcalc%20192.168.4.2.png)  
В строке "Hosts/Net" есть Private Internet

* `ipcalc -b 172.20.250.4`  
![01.3.1.4 ipcalc 172.20.250.4](./images/01.3.1.4%20ipcalc%20172.20.250.4.png)  
В строке "Hosts/Net" есть Private Internet

* `ipcalc -b 172.0.2.1`  
![01.3.1.5 ipcalc 172.0.2.1.png](./images/01.3.1.5%20ipcalc%20172.0.2.1.png)  
В строке "Hosts/Net" нет Private Internet

* `ipcalc -b 192.172.0.1`  
![01.3.1.6 ipcalc 192.172.0.1.png](./images/01.3.1.6%20ipcalc%20192.172.0.1.png)  
В строке "Hosts/Net" нет Private Internet

* `ipcalc -b 172.68.0.2`  
![01.3.1.7 ipcalc 172.68.0.2.png](./images/01.3.1.7%20ipcalc%20172.68.0.2.png)  
В строке "Hosts/Net" нет Private Internet

* `ipcalc -b 172.16.255.255`  
![01.3.1.8 ipcalc 172.16.255.255.png](./images/01.3.1.8%20ipcalc%20172.16.255.255.png)  
В строке "Hosts/Net" есть Private Internet

* `ipcalc -b 10.10.10.10`  
![01.3.1.9 ipcalc 10.10.10.10.png](./images/01.3.1.9%20ipcalc%2010.10.10.10.png)  
В строке "Hosts/Net" есть Private Internet

* `ipcalc -b 192.169.168.1`  
![01.3.1.10 ipcalc 192.169.168.1.png](./images/01.3.1.10%20ipcalc%20192.169.168.1.png)  
В строке "Hosts/Net" нет Private Internet

#### 2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255  
`ipcalc -b 10.10.0.0/18`  
![01.3.2.1 ipcalc 10.10.0.0_18.png](./images/01.3.2.1%20ipcalc%2010.10.0.0_18.png)  
Возможны IP адреса шлюза входящие в диапазон HostMin - HostMax: 10.10.0.2, 10.10.10.10, 10.10.1.255.  

## Part 2. Статическая маршрутизация между двумя машинами  

#### Поднять две виртуальные машины (далее -- ws1 и ws2)
![02.1.1.1 ws1 ws2.png](./images/02.1.1.1%20ws1%20ws2.png)

#### С помощью команды ip a посмотреть существующие сетевые интерфейсы  
* ws1  
![02.1.1.2 ws1 ip a.png](./images/02.1.1.2%20ws1%20ip%20a.png)

* ws2  
![02.1.1.3 ws2 ip a.png](./images/02.1.1.3%20ws2%20ip%20a.png)

#### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12  
* `sudo vim /etc/netplan/00-installer-config.yaml`  
![02.1.1.4 vim etc_netplan_00-installer-config.yaml.png](./images/02.1.1.4%20vim%20etc_netplan_00-installer-config.yaml.png)

* `cat /etc/netplan/00-installer-config.yaml`
![02.1.1.5 cat etc_netplan_00-installer-config.yaml.png](./images/02.1.1.5%20cat%20etc_netplan_00-installer-config.yaml.png)

#### Выполнить команду netplan apply для перезапуска сервиса сети  
* ws1  
![02.1.1.6 ws1 netplan apply.png](./images/02.1.1.6%20ws1%20netplan%20apply.png)

* ws2  
![02.1.1.7 ws2 netplan apply .png](./images/02.1.1.7%20ws2%20netplan%20apply.png)

### 2.1. Добавление статического маршрута вручную  
#### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add  
* ws1: `sudo ip route add 172.24.116.8 via 192.168.100.10`  
![02.1.1.8 ws1 ip r add.png](./images/02.1.1.8%20ws1%20ip%20r%20add.png)

* ws2: `sudo ip route add 192.168.100.10 via 172.24.116.8`  
![02.1.1.9 ws2 ip r add.png](./images/02.1.1.9%20ws2%20ip%20r%20add.png)

#### Пропинговать соединение между машинами  
* ws1  
![02.1.1.10 ws1 ping 172.24.116.8.png](./images/02.1.1.10%20ws1%20ping%20172.24.116.8.png)

* ws2  
![02.1.1.11 ws2 ping 192.168.100.10.png](./images/02.1.1.11%20ws2%20ping%20192.168.100.10.png)

### 2.2. Добавление статического маршрута с сохранением  
#### Перезапустить машины  
* `sudo reboot`  

#### Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml  
![02.2.1.1 vim etc_netplan_00-installer-config.yaml.png](./images/02.2.1.1%20vim%20etc_netplan_00-installer-config.yaml.png)

![02.2.1.2 cat etc_netplan_00-installer-config.yaml.png](./images/02.2.1.2%20cat%20etc_netplan_00-installer-config.yaml.png)

#### Пропинговать соединение между машинами  
![02.2.1.3 netplan apply ping.png](./images/02.2.1.3%20netplan%20apply%20ping.png)

## Part 3. Утилита iperf3  
### 3.1. Скорость соединения  
#### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps  
* 8 Mbps = 1 MB/s  
* 100 MB/s = 819200 Kbps  
* 1 Gbps = 1024 Mbps  

### 3.2. Утилита iperf3  
#### Измерить скорость соединения между ws1 и ws2  
* ws1 - сервер. Запуск iperf3 сервер `iperf3 -s -f m`  
![03.2.1.1 iperf ws1.png](./images/03.2.1.1%20iperf%20ws1.png)

* ws2 - клиент. Запуск iperf3 клиент `iperf3 -c 192.168.100.10`  
![03.2.1.2 iperf ws2.png](./images/03.2.1.2%20iperf%20ws2.png)

## Part 4. Сетевой экран  
### 4.1. Утилита iptables  
#### Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:
    #!/bin/sh  

    # Удаление всех правил в таблице «filter» (по-умолчанию).  
    iptables -F  
    iptables -X  

#### Нужно добавить в файл подряд следующие правила:  

#### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)  

#### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)  

#### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)  

#### 4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)  

#### 5) разрешить echo reply (машина должна "пинговаться")  

* Правила ws1:  
![04.1.1.1 ws1 firewall.sh.png](./images/04.1.1.1%20ws1%20firewall.sh.png)

Открыть доступ для порта 22 (ssh) и порта 80 (http).
Запретить echo reply.
Разрешить echo reply.  

* Правила ws2:  
![04.1.1.2 ws2 firewall.sh.png](./images/04.1.1.2%20ws2%20firewall.sh.png)

Открыть доступ для порта 22 (ssh) и порта 80 (http).
Разрешить echo reply.
Запретить echo reply.  

#### Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`  
* ws1  
![04.1.1.3 ws1 chmod firewall.sh.png](./images/04.1.1.3%20ws1%20chmod%20firewall.sh.png)

* ws2  
![04.1.1.4 ws2 chmod firewall.sh.png](./images/04.1.1.4%20ws2%20chmod%20firewall.sh.png)



* Правила означают: на ws1 все входящие пакеты отклоняются так как первым подходящим правилом для пакета является запрет, на ws2 все входящие пакеты принимаются так как первым подходящим правилом для пакета является разрешение. Применяется только первое подходящее правило, остальные игнорируются.
-F - очистить все правила;
-X - удалить цепочку;
-A - добавить правило в цепочку;
-L - вывести все правила в текущей цепочке;
-p - указать протокол, один из tcp, udp, udplite, icmp, icmpv6,esp, ah, sctp,
mh;
-j - выбрать действие, если правило подошло;
-m multiport - проверка нескольких портов одновременно.

Проверка:
* ws1  
![04.1.1.5 ws1 iptables -L ping .png](./images/04.1.1.5%20ws1%20iptables%20-L%20ping.png)

* ws2  
![04.1.1.6 ws2 iptables -L ping .png](./images/04.1.1.6%20ws2%20iptables%20-L%20ping.png)

### 4.2. Утилита nmap  
#### Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен  
_Проверка: в выводе nmap должно быть сказано: `Host is up`_  
* пинг ws2 с ws1 успешно  
![04.2.1.1 ping ws2 from ws1.png](./images/04.2.1.1%20ping%20ws2%20from%20ws1.png)

* пинг ws1 с ws2 неуспешно. Проверка утилитой nmap.  
![04.2.1.2 ping ws1 from ws2 nmap.png](./images/04.2.1.2%20ping%20ws1%20from%20ws2%20nmap.png)

Есть сообщение `Host is up`  

## Part 5. Статическая маршрутизация сети  
#### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))  
![05.0.1.1 ws11 ws21 ws22 r1 r2.png](./images/05.0.1.1%20ws11%20ws21%20ws22%20r1%20r2.png)

### 5.1. Настройка адресов машин  
#### Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.  
`sudo vim /etc/netplan/00-installer-config.yaml`
`sudo netplan apply`
* ws11  
![05.1.1.1 ws11 vim netplan.png](./images/05.1.1.1%20ws11%20vim%20netplan.png)

* ws21  
![05.1.1.2 ws21 vim netplan.png](./images/05.1.1.2%20ws21%20vim%20netplan.png)

* ws22  
![05.1.1.3 ws22 vim netplan.png](./images/05.1.1.3%20ws22%20vim%20netplan.png)

* r1  
![05.1.1.4 r1 vim netplan.png](./images/05.1.1.4%20r1%20vim%20netplan.png)

* r2  
![05.1.1.5 r2 vim netplan.png](./images/05.1.1.5%20r2%20vim%20netplan.png)

#### Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.  

* ws22  
![05.1.1.6 ws22 ip -4 a ping.png](./images/05.1.1.6%20ws22%20ip%20-4%20a%20ping.png)

* ws21  
![05.1.1.7 ws21 ip -4 a ping.png](./images/05.1.1.7%20ws21%20ip%20-4%20a%20ping.png)

* ws11  
![05.1.1.8 ws11 ip -4 a ping.png](./images/05.1.1.8%20ws11%20ip%20-4%20a%20ping.png)

* r1  
![05.1.1.9 r1 ip -4 a ping.png](./images/05.1.1.9%20r1%20ip%20-4%20a%20ping.png)

* r2  
 ![05.1.1.10 r2 ip -4 a ping.png](./images/05.1.1.10%20r2%20ip%20-4%20a%20ping.png)

### 5.2. Включение переадресации IP-адресов.  
#### Для включения переадресации IP, выполните команду на роутерах:  
`sysctl -w net.ipv4.ip_forward=1`  
![05.2.1.1 r1 sysctl forward.png](./images/05.2.1.1%20r1%20sysctl%20forward.png)

![05.2.1.2 r2 sysctl forward.png](./images/05.2.1.2%20r2%20sysctl%20forward.png)

#### Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:  
`net.ipv4.ip_forward = 1`  

![05.2.1.3 r1 vim etc_sysctl.conf.png](./images/05.2.1.3%20r1%20vim%20etc_sysctl.conf.png)

![05.2.1.4 r2 vim etc_sysctl.conf.png](./images/05.2.1.4%20r2%20vim%20etc_sysctl.conf.png)

### 5.3. Установка маршрута по-умолчанию  
#### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций  
* ws11  
![05.3.1.1 ws11 default route.png](./images/05.3.1.1%20ws11%20default%20route.png)

* ws21  
![05.3.1.2 ws21 default route.png](./images/05.3.1.2%20ws21%20default%20route.png)

* ws22  
![05.3.1.3 ws22 default route.png](./images/05.3.1.3%20ws22%20default%20route.png)

* r1  
![05.3.1.4 r1 route.png](./images/05.3.1.4%20r1%20route.png)

* r2  
![05.3.1.5 r2 route.png](./images/05.3.1.5%20r2%20route.png)

#### Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации  
* ws11  
![05.3.1.6 ws11 ip r.png](./images/05.3.1.6%20ws11%20ip%20r.png)

* ws21  
![05.3.1.7 ws21 ip r.png](./images/05.3.1.7%20ws21%20ip%20r.png)

* ws22  
![05.3.1.8 ws22 ip r.png](./images/05.3.1.8%20ws22%20ip%20r.png)

* r1  
![05.3.1.9 r1 ip r.png](./images/05.3.1.9%20r1%20ip%20r.png)

* r2  
![05.3.1.10 r2 ip r.png](./images/05.3.1.10%20r2%20ip%20r.png)

#### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:  
`tcpdump -tn -i eth1`  
Изменяем eth1 на название нашего адаптера enp0s9 и пингуем:  
* ws11  
`ping 10.100.0.12`  
![05.3.1.11 ws11 ping r2.png](./images/05.3.1.11%20ws11%20ping%20r2.png)

* r2  
`tcpdump -tn -i enp0s9`  
![05.3.1.12 r2 tcpdump.png](./images/05.3.1.12%20r2%20tcpdump.png)

### 5.4. Добавление статических маршрутов  
#### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:  
    # Добавить в конец описания сетевого интерфейса eth1:  
    - to: 10.20.0.0  
      via: 10.100.0.12  
* r1  
![05.4.1.1 r1 route.png](./images/05.4.1.1%20r1%20route.png)

* r2  
![05.4.1.2 r2 route.png](./images/05.4.1.2%20r2%20route.png)

#### Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.  
* r1  
![05.4.1.3 r1 ip r.png](./images/05.4.1.3%20r1%20ip%20r.png)

* r2  
![05.4.1.4 r2 ip r.png](./images/05.4.1.4%20r2%20ip%20r.png)

#### Запустить команды на ws11:  
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`  

* ws11  
![05.4.1.5 ws11 ip r list.png](./images/05.4.1.5%20ws11%20ip%20r%20list.png)
 
* Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию, так как приоритет маршрута по умолчанию ниже чем приоритет более точного подходящего маршрута. У нас есть маршрут для 10.10.0.0/18, поэтому выбран именно он, а не default.

### 5.5. Построение списка маршрутизаторов  
#### Запустить на r1 команду дампа:  
`tcpdump -tnv -i eth0`  

#### При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21  
* ws11  
`sudo apt install traceroute`  
`traceroute 10.20.0.10`  
![05.5.1.1 ws11 traceroute.png](./images/05.5.1.1%20ws11%20traceroute.png)

* r1  
`tcpdump -tnv -i enp0s8 proto UDP`  
![05.5.1.2 r1 tcpdump.png](./images/05.5.1.2%20r1%20tcpdump.png)

UDP пакет от исходного ws11 (10.10.0.2) к конечному ws21 (10.20.0.10)
сначала идет к шлюзу r1 (10.10.0.1), затем идет на шлюз 10.100.0.12, далее направляеся в целевую подсеть 10.20.0.
Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.
Команда traceroute использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной..  

### 5.6. Использование протокола ICMP при маршрутизации  
#### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:  
`tcpdump -n -i eth0 icmp`  

#### Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:  
`ping -c 1 10.30.0.111`  

* r1  
![05.6.1.1 r1 tcpdump.png](./images/05.6.1.1%20r1%20tcpdump.png)

* ws11  
![05.6.1.2 ws11 ping 10.30.0.111.png](./images/05.6.1.2%20ws11%20ping%2010.30.0.111.png)

## Part 6. Динамическая настройка IP с помощью DHCP  
#### Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:  
r2 установка пакета службы DHCP
`sudo apt install isc-dhcp-server`
#### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.  
r2  настройка конфигурации службы DHCP (файл /etc/dhcp/dhcpd.conf)
![06.1.1.1 etc_dhcp_dhcpd.conf.png](./images/06.1.1.1%20etc_dhcp_dhcpd.conf.png)

#### 2) в файле resolv.conf прописать nameserver 8.8.8.8.  
r2 DNS server (файл /etc/resolv.conf)  
![06.2.1.1 r2 etc_resolv.conf.png](./images/06.2.1.1%20r2%20etc_resolv.conf.png)

#### Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.  
* r2 перезагрузка службы DHCP  
![06.2.1.2 r2 systemctl restart isc-dhcp-server.png](./images/06.2.1.2%20r2%20systemctl%20restart%20isc-dhcp-server.png)

* ws21 настройка сетевого интерфейса  
![06.2.1.3 ws21 dhcp-true.png](./images/06.2.1.3%20ws21%20dhcp-true.png)

* ws21  
`sudo reboot`  
`ip a`  
выдан IP-адрес 10.20.0.2  
![06.2.1.4 ws21 ip a.png](./images/06.2.1.4%20ws21%20ip%20a.png)

* ws21 пинг ws22  
![06.2.1.5 ws21 ping ws22.png](./images/06.2.1.5%20ws21%20ping%20ws22.png)

#### Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true  
* ws11 настройка сетевого интерфейса  
![06.2.1.6 ws11 dhcp4-true macaddress.png](./images/06.2.1.6%20ws11%20dhcp4-true%20macaddress.png)

#### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты  
* r1 установка пакета службы DHCP
`sudo apt install isc-dhcp-server`  

* r1  настройка конфигурации службы DHCP (файл /etc/dhcp/dhcpd.conf)  
![06.2.1.7 r1 etc_dhcp_dhcpd.conf.png](./images/06.2.1.7%20r1%20etc_dhcp_dhcpd.conf.png)

* r1 DNS server (файл /etc/resolv.conf)  
![06.2.1.8 r1 etc_resolv.conf.png](./images/06.2.1.8%20r1%20etc_resolv.conf.png)

* r1 перезагрузка службы DHCP   
![06.2.1.9 r1 systemctl restart isc-dhcp-server.png](./images/06.2.1.9%20r1%20systemctl%20restart%20isc-dhcp-server.png)

* ws11
`sudo reboot`
`ip a`  
выдан IP-адрес 10.10.0.5  
![06.2.1.10 ws11 ip a.png](./images/06.2.1.10%20ws11%20ip%20a.png)

* ws11 пинг ws 21 и ws22  
![06.2.1.11 ws11 ping ws21 and ws22.png](./images/06.2.1.11%20ws11%20ping%20ws21%20and%20ws22.png)

#### Запросить с ws21 обновление ip адреса  
* ws21 до обновления  
![06.2.1.12 ws21 ip a before ip update.png](./images/06.2.1.12%20ws21%20ip%20a%20before%20ip%20update.png)

* ws21  
`sudo dhclient enp0s8 -r`  
-r - освободить текущий адрес;  
`sudo dhclient enp0s8`  
`ip a`  
![06.2.1.13 ws21 dhclient -r ip a.png](./images/06.2.1.13%20ws21%20dhclient%20-r%20ip%20a.png)

## Part 7. NAT  
#### В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным  
* ws22  
![07.0.0.1 ws22 etc_apache2_ports.conf 0.0.0.0:80.png](./images/07.0.0.1%20ws22%20etc_apache2_ports.conf%200.0.0.0_80.png)

* r1  
![07.0.0.2 r1 etc_apache2_ports.conf 0.0.0.0:80.png](./images/07.0.0.2%20r1%20etc_apache2_ports.conf%200.0.0.0_80.png)

#### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1  
* ws22  
![07.0.0.3 ws22 service apache2 start.png](./images/07.0.0.3%20ws22%20service%20apache2%20start.png)

* r1  
![07.0.0.4 r1 service apache2 start.png](./images/07.0.0.4%20r1%20service%20apache2%20start.png)

#### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:  
1) Удаление правил в таблице filter - iptables -F
2) Удаление правил в таблице "NAT" - iptables -F -t nat
3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP  

#### Запускать файл также, как в Части 4  
![07.0.0.5 r2 etc_firewall.sh.png](./images/07.0.0.5%20r2%20etc_firewall.sh.png)

#### Проверить соединение между ws22 и r1 командой ping  
![07.0.0.6 r1 ping ws22 fail.png](./images/07.0.0.6%20r1%20ping%20ws22%20fail.png)

#### Добавить в файл ещё одно правило:  
4) Разрешить маршрутизацию всех пакетов протокола ICMP  

#### Запускать файл также, как в Части 4  
![07.0.0.7 r2 firewall.sh add icmp.png](./images/07.0.0.7%20r2%20firewall.sh%20add%20icmp.png)

#### Проверить соединение между ws22 и r1 командой ping  
![07.0.0.8 r1 ping ws22 success.png](./images/07.0.0.8%20r1%20ping%20ws22%20success.png)

#### Добавить в файл ещё два правила:  
5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети  

#### Запускать файл также, как в Части 4  
![07.0.0.9 r2 SNAT DNAT.png](./images/07.0.0.9%20r2%20SNAT%20DNAT.png)

#### Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:  
`telnet [адрес] [порт]`  
![07.0.0.10 ws22 telnet to apache r1.png](./images/07.0.0.10%20ws22%20telnet%20to%20apache%20r1.png)

#### Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)  
![07.0.0.11 r1 telnet apache ws22 (ip r2 port8080).png](./images/07.0.0.11%20r1%20telnet%20apache%20ws22%20%28ip%20r2%20port8080%29.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels  
#### Запустить на r2 фаервол с правилами из Части 7  
* r2  
![08.0.0.1 r2 firewall.png](./images/08.0.0.1%20r2%20firewall.png)

#### Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле _/etc/apache2/ports.conf_ изменить строку `Listen 80` на `Listen localhost:80`)  
* ws22 
`sudo apt-get install ssh`  
![08.0.0.2 ws22 apache2 localhost.png](./images/08.0.0.2%20ws22%20apache2%20localhost.png)

#### Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21  
* ws21
`ssh -L [local_port]:localhost:[local_port] [remote_ip]`  
![08.0.0.3 ws21 ssh -L 4321:localhost:80 ws@10.20.0.20.png](./images/08.0.0.3%20ws21%20ssh%20-L%204321_localhost_80%20ws@10.20.0..png)
![08.0.0.4 ws21 connected to ws22.png](./images/08.0.0.4%20ws21%20connected%20to%20ws22.png)

* проверяем с помощью команды `telnet 127.0.0.1 4321`  
![08.0.0.5 ws21 telnet 127.0.0.1 4321.png](./images/08.0.0.5%20ws21%20telnet%20127.0.0.1%204321.png)

#### Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11  
* ws11
`ssh -R [remote_port]:localhost:[local_port] [remote_ip]`  
![08.0.0.6 ws11 ssh -R 4321:localhost:80 ws22@10.20.0.20.png](./images/08.0.0.6%20ws11%20ssh%20-R%204321_localhost_80%20ws22@10.20..png)
![08.0.0.7 ws11 connected ws22.png](./images/08.0.0.7%20ws11%20connected%20ws22.png)

* проверяем с помощью команды `telnet 127.0.0.1 80`  
![08.0.0.8 ws11 telnet 127.0.0.1 80.png](./images/08.0.0.8%20ws11%20telnet%20127.0.0.1%2080.png)
